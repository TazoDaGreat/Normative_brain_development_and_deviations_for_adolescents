---
title: "residual_modeling"
output: html_document
---

```{r}
library(readr)
library(dplyr)
library(ggplot2)
```

```{r}
data_dir <- '~/Library/CloudStorage/Box-Box/'

setwd(data_dir)

thickness_centile_male_mean <- read.csv("thickness/final_data_male.csv") %>%
  filter(current_col_name == "smri_thick_cdk_mean.combat")

thickness_centile_female_mean <- read.csv("thickness/final_data_female.csv") %>%
  filter(current_col_name == "smri_thick_cdk_mean.combat")
```
Let's take a look at the racial bias of our gamlss error with RMSE

```{r}
thickness_male_RMSE <- thickness_centile_male_mean %>%
  mutate(
    residual_sqr_baseline = residual_baseline_year_1_arm_1^2,
    residual_sqr_year2 = residual_2_year_follow_up_y_arm_1^2,
    residual_sqr_year4 = residual_4_year_follow_up_y_arm_1^2
  ) %>%
  {
    race_RMSE <- group_by(., race_ethnicity) %>%
      summarize(
        RMSE_residual_baseline = sqrt(mean(residual_sqr_baseline, na.rm = TRUE)),
        RMSE_residual_year2 = sqrt(mean(residual_sqr_year2, na.rm = TRUE)),
        RMSE_residual_year4 = sqrt(mean(residual_sqr_year4, na.rm = TRUE)),
        .groups = "drop"
      )
    
    overall_RMSE <- summarize(., 
      race_ethnicity = "All",
      RMSE_residual_baseline = sqrt(mean(residual_sqr_baseline, na.rm = TRUE)),
      RMSE_residual_year2 = sqrt(mean(residual_sqr_year2, na.rm = TRUE)),
      RMSE_residual_year4 = sqrt(mean(residual_sqr_year4, na.rm = TRUE))
    )
    
    bind_rows(race_summary, overall_summary)
  }
```

```{r}
thickness_male_RMSE %>% 
  ggplot(aes(race_ethnicity, RMSE_residual_baseline)) +
  geom_col() +
  theme_classic() +
  labs(title = "Baseline RMSE of Residuals by Race/Ethnicity",
       subtitle = "Males",
       y = "RMSE Percentage" ) 
```

```{r}

rmse_all_baseline <- thickness_male_RMSE %>% 
  filter(race_ethnicity == "All") %>% 
  pull(RMSE_residual_baseline)

rmse_all_year2 <- thickness_male_RMSE %>% 
  filter(race_ethnicity == "All") %>% 
  pull(RMSE_residual_year2)

rmse_all_year4 <- thickness_male_RMSE %>% 
  filter(race_ethnicity == "All") %>% 
  pull(RMSE_residual_year4)

# Prep the data
plot_data <- thickness_male_RMSE %>%
  mutate(
    RMSE_residual_baseline_pct = RMSE_residual_baseline * 100,
    RMSE_residual_year2_pct = RMSE_residual_year2 * 100,
    RMSE_residual_year4_pct = RMSE_residual_year4 * 100,
    color_group_baseline = case_when(
      race_ethnicity == "All" ~ "Average",
      RMSE_residual_baseline > rmse_all_baseline ~ "Above Average",
      TRUE ~ "Below Average"
    ),
    color_group_year2 = case_when(
      race_ethnicity == "All" ~ "Average",
      RMSE_residual_year2 > rmse_all_year2 ~ "Above Average",
      TRUE ~ "Below Average"
    ),
    color_group_year4 = case_when(
      race_ethnicity == "All" ~ "Average",
      RMSE_residual_year4 > rmse_all_year4 ~ "Above Average",
      TRUE ~ "Below Average"
    )
  )

# Create the ggplot
baseline_p <- plot_data %>%
  ggplot(aes(x = race_ethnicity, 
             y = RMSE_residual_baseline_pct,
             fill = color_group_baseline,
             text = paste0("RMSE: ", round(RMSE_residual_baseline_pct, 2), "%"))) +
  geom_col() +
  scale_fill_manual(values = c("Above Average" = "#e94f58", "Below Average" = "#3a5d9c")) +
  theme_classic() +
  labs(
    title = "Baseline RMSE of Residuals by Race/Ethnicity (Males)",
    subtitle = "Males",
    y = "RMSE Percentage",
    fill = ""
  )

year2_p <- plot_data %>%
  ggplot(aes(x = race_ethnicity, 
             y = RMSE_residual_year2_pct,
             fill = color_group_year2,
             text = paste0("RMSE: ", round(RMSE_residual_year2_pct, 2), "%"))) +
  geom_col() +
  scale_fill_manual(values = c("Above Average" = "#e94f58", "Below Average" = "#3a5d9c")) +
  theme_classic() +
  labs(
    title = "Year 2 RMSE of Residuals by Race/Ethnicity (Males)",
    subtitle = "Males",
    y = "RMSE Percentage",
    fill = ""
  )

year4_p <- plot_data %>%
  ggplot(aes(x = race_ethnicity, 
             y = RMSE_residual_year4_pct,
             fill = color_group_year4,
             text = paste0("RMSE: ", round(RMSE_residual_year4_pct, 3), "%"))) +
  geom_col() +
  scale_fill_manual(values = c("Above Average" = "#e94f58", "Below Average" = "#3a5d9c")) +
  theme_classic() +
  labs(
    title = "Year 4 RMSE of Residuals by Race/Ethnicity (Males)",
    subtitle = "Males",
    y = "RMSE Percentage",
    fill = ""
  )

plotly::ggplotly(baseline_p, tooltip = "text")
plotly::ggplotly(year2_p, tooltip = "text")
plotly::ggplotly(year4_p, tooltip = "text")
```

