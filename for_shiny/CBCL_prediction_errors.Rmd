---
title: "CBCL_prediction_errors"
author: Jeffrey Choi
output: html_document
---

```{r}
library(readr)
library(dplyr)
library(tidyr)
library(ggplot2)
library(plotly)
library(ggseg)
library(stringr)
library(forcats)
```

```{r}
brain_data_male <- read_csv("~/Library/CloudStorage/Box-Box/thickness/final_data_male_year4_mh.csv")
brain_data_female <- read_csv("~/Library/CloudStorage/Box-Box/thickness/final_data_female_year4_mh.csv")
```

```{r}
# contains people multiple times for each race/ethnicity they are
# RUN THIS FOR AREA
brain_data_male <- brain_data_male %>% 
  pivot_longer(cols = c(White_race, Black_race, AIAN_race, NHPI_race,
         Asian_race, Other_race, Missing_race, demo_ethn_v2),
    names_to = "race_ethnicity",
    values_to = "indicator") %>% 
  filter(indicator == 1) %>%
  select(-indicator) %>% 
  # recode race_ethnicity variable names 
  mutate(race_ethnicity = recode(race_ethnicity, White_race = "White",
                                 demo_ethn_v2 = "Hispanic", Black_race =  "Black",
                                 AIAN_race =  "AIAN", NHPI_race =  "NHPI",
                                 Asian_race = "Asian", Other_race = "Other",
                                 Missing_race = "Missing")) 

brain_data_female <- brain_data_female %>% 
  pivot_longer(cols = c(White_race, Black_race, AIAN_race, NHPI_race,
         Asian_race, Other_race, Missing_race, demo_ethn_v2),
    names_to = "race_ethnicity",
    values_to = "indicator") %>% 
  filter(indicator == 1) %>%
  select(-indicator) %>% 
  # recode race_ethnicity variable names 
  mutate(race_ethnicity = recode(race_ethnicity, White_race = "White",
                                 demo_ethn_v2 = "Hispanic", Black_race =  "Black",
                                 AIAN_race =  "AIAN", NHPI_race =  "NHPI",
                                 Asian_race = "Asian", Other_race = "Other",
                                 Missing_race = "Missing"))
```

Let's first look at psychopathology prediction models without race and other demogs as covariates,
and compare the centile/z-score prediction errors to raw scores

```{r}
cbcl_outcomes <- c(
  internal = "cbcl_scr_syn_internal_r",
  external = "cbcl_scr_syn_external_r",
  depression = "cbcl_scr_dsm5_depress_r"
)

predictor_sets <- list(
  centile = c("centile_slope", "centile_intercept"),
  raw     = c("raw_slope", "raw_intercept"),
  z_score = c("z_score_slope", "z_score_intercept")
)

# split big df into region specific dfs
region_dfs <- split(brain_data_male, brain_data_male$current_col_name)

# Fits model per region, saves predicted values and residuals
fit_models_for_region <- function(df_sub) {
  # for each cbcl independent variable 
  for (outcome in cbcl_outcomes) {
    for (pred_type in names(predictor_sets)) { # for each set of predictor types
      
      predictors <- predictor_sets[[pred_type]] # saves as predictors string
      formula <- as.formula(paste(outcome, "~", paste(predictors, collapse = " + "))) # builds formula
      
      model <- tryCatch(
        glm(formula, data = df_sub, family = "poisson"), # fits model
        error = function(e) return(NULL) # returns null if doesn't work (they all should)
      )
      
      if (!is.null(model)) { 
        resid <- resid(model, type = "pearson")
        resid_col <- paste0("resid_", outcome, "_", pred_type) # make residual values col
        
        # adds predicteds and residuals to df_sub matching model rows
        df_model_rows <- model.frame(model)
        idx <- match(rownames(df_model_rows), rownames(df_sub))
        
        # saves predicteds and residuals into df_sub
        df_sub[[resid_col]][idx] <- resid
      }
    }
  }
  return(df_sub)
}

region_dfs_predicted <- lapply(region_dfs, fit_models_for_region) # run function over all regions
brain_data_male_predicted <- bind_rows(region_dfs_predicted) # combine region df list back into one

region_dfs <- split(brain_data_female, brain_data_female$current_col_name)
region_dfs_predicted <- lapply(region_dfs, fit_models_for_region) # run function over all regions
brain_data_female_predicted <- bind_rows(region_dfs_predicted) # combine region df list back into one
```

Let's plot the race/ethnicity distribution in our models (who is in our data)
```{r}
brain_data_male_predicted %>%
  filter(if_all(starts_with("resid_"), ~ !is.na(.))) %>%
  count(race_ethnicity) %>%
  ggplot(aes(x = fct_reorder(race_ethnicity, n), y = n)) +
  geom_col(fill = "#6baed6") +
  coord_flip() +
  geom_text(aes(label = n), hjust = -0.1, size = 4) +
  expand_limits(y = 120000) +
  labs(
    x = "Race/Ethnicity",
    y = "Count",
    title = "Distribution of Race/Ethnicity in Psychopathology Modeling",
    subtitle = "Males"
  ) +
  theme_minimal()

brain_data_male_predicted %>%
  filter(!is.na(cbcl_scr_syn_internal_r)) %>%
  ggplot(aes(x = cbcl_scr_syn_internal_r)) +
  geom_histogram(binwidth = 1, fill = "#6baed6", color = "white") +
  labs(
    x = "CBCL Internalizing Score",
    y = "Count",
    title = "Distribution of CBCL Internalizing Scores",
    subtitle = "Males"
  ) +
  theme_minimal()
brain_data_male_predicted %>%
  filter(!is.na(cbcl_scr_syn_external_r)) %>%
  ggplot(aes(x = cbcl_scr_syn_external_r)) +
  geom_histogram(binwidth = 1, fill = "#6baed6", color = "white") +
  labs(
    x = "CBCL Externalizing Score",
    y = "Count",
    title = "Distribution of CBCL Externalizing Scores",
    subtitle = "Males"
  ) +
  theme_minimal()
brain_data_male_predicted %>%
  filter(!is.na(cbcl_scr_dsm5_depress_r)) %>%
  ggplot(aes(x = cbcl_scr_dsm5_depress_r)) +
  geom_histogram(binwidth = 1, fill = "#6baed6", color = "white") +
  labs(
    x = "CBCL Depression Score",
    y = "Count",
    title = "Distribution of CBCL Depression Scores",
    subtitle = "Males"
  ) +
  theme_minimal()

brain_data_male_predicted %>%
  distinct(src_subject_id) %>%
  count()
```

```{r}
brain_data_female_predicted %>%
  pivot_longer(
    cols = c("cbcl_scr_syn_internal_r", "cbcl_scr_syn_external_r", "cbcl_scr_dsm5_depress_r"),
    names_to = "cbcl_score",
    values_to = "value"
  ) %>%
  group_by(race_ethnicity, cbcl_score) %>%
  summarize(
    Q1 = quantile(value, 0.25, na.rm = TRUE),
    Q2 = quantile(value, 0.50, na.rm = TRUE),
    Q3 = quantile(value, 0.75, na.rm = TRUE),
    .groups = "drop"
  )

brain_data_male_predicted %>%
  filter(if_any(c("cbcl_scr_syn_internal_r", "cbcl_scr_syn_external_r", "cbcl_scr_dsm5_depress_r"), ~ !is.na(.))) %>%
  nrow()
```

```{r}
dk_abv_to_names = read.csv("~/Documents/GitHub/Normative_brain_development_and_deviations_for_adolescents/exploration/additional_files/dk_abv_to_names.csv")
# returns region name from abcd abv
get_name <- function(dk_abv_to_names, abv){
  (dk_abv_to_names %>% filter(var_name == abv))$region
}

dk_df <- as_tibble(dk)
```

```{r}
plot_brain_residual_diff <- function(
  brain_data,
  race_subset,
  residual_col,
  title = "Residual Deviation from White",
  subtitle = "Male",
  limits
  ) {
  # saves relevent col name as symbol?
  # idk why this works, thank you chatgpt
  residual_col_sym <- rlang::sym(residual_col)
  
  # for this specific residual col in the df, find average rmse by race and for all
  processed <- brain_data %>%
    filter(race_ethnicity %in% race_subset) %>% 
    mutate(residual_sqr = (!!residual_col_sym)^2) %>%
    ungroup() %>%
    {
      race_region_RMSE <- group_by(., current_col_name, race_ethnicity) %>%
        summarize(
          RMSE_residual = sqrt(mean(residual_sqr, na.rm = TRUE)),
          .groups = "drop"
        ) %>%
        rename(region_raw = current_col_name)
      
      overall_region_RMSE <- group_by(., current_col_name) %>%
        summarize(
          race_ethnicity = "All",
          RMSE_residual = sqrt(mean(residual_sqr, na.rm = TRUE)),
          .groups = "drop"
        ) %>%
        rename(region_raw = current_col_name)
      
      bind_rows(race_region_RMSE, overall_region_RMSE)
    } %>%
    # sets up region name cols for ggseg 
    mutate(
      abv = str_remove(region_raw, "^smri_thick_cdk_"), #CHANGE THIS FOR AREA
      abv = str_remove(abv, "\\.combat$"),
      hemi = case_when(
        str_detect(abv, "lh$") ~ "left",
        str_detect(abv, "rh$") ~ "right",
        TRUE ~ NA_character_
      )
    ) %>%
    rowwise() %>%
    filter(!abv %in% 
           c("total", "totallh", "totalrh")) %>% 
    filter(!region_raw %in% 
           c("smri_thick_cdk_mean.combat", 
             "smri_thick_cdk_meanlh.combat",
             "smri_thick_cdk_meanrh.combat")) %>% 
    mutate(region = get_name(dk_abv_to_names, abv)) %>%
    ungroup()
  
  # we can't need to plot these
  plot_df <- processed %>%
    filter(!abv %in% 
           c("total", "totallh", "totalrh")) %>%
    # find percent difference from white
    group_by(region_raw) %>%
    mutate(
      all_value = RMSE_residual[race_ethnicity == "White"],
      diff = RMSE_residual - all_value,
      rel_diff = (RMSE_residual - all_value) / all_value,
    ) %>%
    # drop white and missings from analysis
    filter(race_ethnicity != "White", race_ethnicity != "Missing")
  
  # compute color gradiant limits by most extreme rel_diff value
  min <- (min(plot_df$rel_diff)) * 100
  max <- (max(plot_df$rel_diff)) * 100

  joined <- brain_join(dk_df, plot_df, by = c("region", "hemi"))

  joined %>%
    mutate(hover = paste0(region, ": ", round(rel_diff * 100, 2), "%")) %>%
    drop_na() %>%
    group_by(race_ethnicity) %>%
    ggplot() +
    geom_brain(atlas = dk,
               position = position_brain(hemi ~ side),
               mapping = aes(fill = rel_diff * 100)) +
    labs(
      title = title,
      subtitle = subtitle
    ) +
    facet_wrap(~race_ethnicity) +
    scale_fill_gradientn(
      name = "Relative Deviation from White (%)",
      colors = c("#23171B", "#443983", "#31688E", "#21918C", "#35B779", "#90D743", "#FDE725", "#F39C12", "#D7191C"),
      limits = c(min, max)
    ) +
    theme_void()
}
```

```{r}
# Internalizing Scores
plot_brain_residual_diff(
  brain_data = brain_data_male_predicted,
  residual_col = "resid_cbcl_scr_syn_internal_r_centile",
  title = "Male CBCL Internalizing Residuals Relative to White (Cortical Thickness)",
  subtitle = "Centile Predictors - No Demographic Covariates",
  limits = c(8,12)
)
plot_brain_residual_diff(
  brain_data = brain_data_male_predicted,
  residual_col = "resid_cbcl_scr_syn_internal_r_raw",
  title = "Male CBCL Internalizing Residuals Relative to White (Cortical Thickness)",
  subtitle = "Raw Predictors - No Demographic Covariates",
  limits = c(8,12)
)
plot_brain_residual_diff(
  brain_data = brain_data_male_predicted,
  residual_col = "resid_cbcl_scr_syn_internal_r_z_score",
  title = "Male CBCL Internalizing Residuals Relative to White (Cortical Thickness)",
  subtitle = "Z-Score Predictors - No Demographic Covariates",
  limits = c(8,12)
)
```

```{r}
# Externalizing Scores
plot_brain_residual_diff(
  brain_data = brain_data_male_predicted,
  residual_col = "resid_cbcl_scr_syn_external_r_centile",
  title = "Male CBCL Externalizing Residuals Relative to White (Cortical Thickness)",
  subtitle = "Centile Predictors - No Demographic Covariates",
  limits = c(5,12)
)
plot_brain_residual_diff(
  brain_data = brain_data_male_predicted,
  residual_col = "resid_cbcl_scr_syn_external_r_raw",
  title = "Male CBCL Externalizing Residuals Relative to White (Cortical Thickness)",
  subtitle = "Raw Predictors - No Demographic Covariates",
  limits = c(5,12)
)
plot_brain_residual_diff(
  brain_data = brain_data_male_predicted,
  residual_col = "resid_cbcl_scr_syn_external_r_z_score",
  title = "Male CBCL Externalizing Residuals Relative to White (Cortical Thickness)",
  subtitle = "Z-Score Predictors - No Demographic Covariates",
  limits = c(3,14)
)
```

```{r}
# Depression Scores
plot_brain_residual_diff(
  brain_data = brain_data_male_predicted,
  residual_col = "resid_cbcl_scr_dsm5_depress_r_centile",
  title = "Relative Difference in CBCL Depression Score Error from White",
  subtitle = "Male - Cortical Thickness Centile Predictors - No Demographic Covariates",
  limits = c(4.4,8.8)
)
plot_brain_residual_diff(
  brain_data = brain_data_male_predicted,
  residual_col = "resid_cbcl_scr_dsm5_depress_r_raw",
  title = "Male CBCL Depression Residuals Relative to White (Cortical Thickness)",
  subtitle = "Raw Predictors - No Demographic Covariates",
  limits = c(4.4,8.8)
)
plot_brain_residual_diff(
  brain_data = brain_data_male_predicted,
  residual_col = "resid_cbcl_scr_dsm5_depress_r_z_score",
  title = "Male CBCL Depression Residuals Relative to White (Cortical Thickness)",
  subtitle = "Z-Score Predictors - No Demographic Covariates",
  limits = c(4.4,8.8)
)
```

Now lets consider just race in our glm
```{r}
cbcl_outcomes <- c(
  internal = "cbcl_scr_syn_internal_r",
  external = "cbcl_scr_syn_external_r",
  depression = "cbcl_scr_dsm5_depress_r"
)

# now we include race as a predictor
predictor_sets <- list(
  centile = c("centile_slope", "centile_intercept", "race_ethnicity"),
  raw     = c("raw_slope", "raw_intercept", "race_ethnicity"),
  z_score = c("z_score_slope", "z_score_intercept", "race_ethnicity")
)

# split big df into region specific dfs
region_dfs <- split(brain_data_male, brain_data_male$current_col_name)

# Fits model per region, saves predicted values and residuals
fit_models_for_region_w_race <- function(df_sub) {
  # for each cbcl independent variable 
  for (outcome in cbcl_outcomes) {
    for (pred_type in names(predictor_sets)) { # for each set of predictor types
      
      predictors <- predictor_sets[[pred_type]] # saves as predictors string
      formula <- as.formula(paste(outcome, "~", paste(predictors, collapse = " + "))) # builds formula
      
      model <- tryCatch(
        glm(formula, data = df_sub, family = "poisson"), # fits model
        error = function(e) return(NULL) # returns null if doesn't work (they all should)
      )
      
      if (!is.null(model)) { 
        preds <- predict(model, type = "response") # save predicted values
        actual <- model$y # grab actual values
        
        pred_col <- paste0("pred_", outcome, "_", pred_type) # make predicted values col
        resid_col <- paste0("resid_", outcome, "_", pred_type) # make residual values col
        
        # adds predicteds and residuals to df_sub matching model rows
        df_model_rows <- model.frame(model)
        idx <- match(rownames(df_model_rows), rownames(df_sub))
        
        # saves predicteds and residuals into df_sub
        df_sub[[pred_col]][idx] <- preds
        df_sub[[resid_col]][idx] <- preds - actual
      }
    }
  }
  return(df_sub)
}

region_dfs_predicted_w_race <- lapply(region_dfs, fit_models_for_region_w_race) # run function over all regions
brain_data_male_predicted_w_race <- bind_rows(region_dfs_predicted_w_race) # combine region df list back into one

region_dfs <- split(brain_data_female, brain_data_female$current_col_name)
region_dfs_predicted_w_race <- lapply(region_dfs, fit_models_for_region_w_race) # run function over all regions
brain_data_female_predicted_w_race <- bind_rows(region_dfs_predicted_w_race) # combine region df list back into one
```

```{r}
# Internalizing Scores
plot_brain_residual_diff(
  brain_data = brain_data_male_predicted_w_race,
  residual_col = "resid_cbcl_scr_syn_internal_r_centile",
  title = "Male CBCL Internalizing Residuals Relative to White (Cortical Thickness)",
  subtitle = "Centile Predictors - Race as Covariate",
  limits = c(9,12)
)
plot_brain_residual_diff(
  brain_data = brain_data_male_predicted_w_race,
  residual_col = "resid_cbcl_scr_syn_internal_r_raw",
  title = "Male CBCL Internalizing Residuals Relative to White (Cortical Thickness)",
  subtitle = "Raw Predictors - Race as Covariate",
  limits = c(9,12)
)
plot_brain_residual_diff(
  brain_data = brain_data_male_predicted_w_race,
  residual_col = "resid_cbcl_scr_syn_internal_r_z_score",
  title = "Male CBCL Internalizing Residuals Relative to White (Cortical Thickness)",
  subtitle = "Z-Score Predictors - Race as Covariate",
  limits = c(9,12)
)
```

```{r}
# Externalizing Scores
plot_brain_residual_diff(
  brain_data = brain_data_male_predicted_w_race,
  residual_col = "resid_cbcl_scr_syn_external_r_centile",
  title = "Male CBCL Externalizing Residuals Relative to White (Cortical Thickness)",
  subtitle = "Centile Predictors - Race as Covariate",
  limits = c(7,11)
)
plot_brain_residual_diff(
  brain_data = brain_data_male_predicted_w_race,
  residual_col = "resid_cbcl_scr_syn_external_r_raw",
  title = "Male CBCL Externalizing Residuals Relative to White (Cortical Thickness)",
  subtitle = "Raw Predictors - Race as Covariate",
  limits = c(7,11)
)
plot_brain_residual_diff(
  brain_data = brain_data_male_predicted_w_race,
  residual_col = "resid_cbcl_scr_syn_external_r_z_score",
  title = "Male CBCL Externalizing Residuals Relative to White (Cortical Thickness)",
  subtitle = "Z-Score Predictors - Race as Covariate",
  limits = c(7,11)
)
```

```{r}
# Depression Scores
plot_brain_residual_diff(
  brain_data = brain_data_male_predicted_w_race,
  residual_col = "resid_cbcl_scr_dsm5_depress_r_centile",
  title = "Male CBCL Depression Residuals Relative to White (Cortical Thickness)",
  subtitle = "Centile Predictors - Race as Covariate",
  limits = c(5,7.7)
)
plot_brain_residual_diff(
  brain_data = brain_data_male_predicted_w_race,
  residual_col = "resid_cbcl_scr_dsm5_depress_r_raw",
  title = "Male CBCL Depression Residuals Relative to White (Cortical Thickness)",
  subtitle = "Raw Predictors - Race as Covariate",
  limits = c(5,7.7)
)
plot_brain_residual_diff(
  brain_data = brain_data_male_predicted_w_race,
  residual_col = "resid_cbcl_scr_dsm5_depress_r_z_score",
  title = "Male CBCL Depression Residuals Relative to White (Cortical Thickness)",
  subtitle = "Z-Score Predictors - Race as Covariate",
  limits = c(5,7.7)
)
```

Now lets check all covariates
```{r}
cbcl_outcomes <- c(
  internal = "cbcl_scr_syn_internal_r",
  external = "cbcl_scr_syn_external_r",
  depression = "cbcl_scr_dsm5_depress_r"
)

# now we include race, income, and education as a predictors
predictor_sets <- list(
  centile = c("centile_slope", "centile_intercept", "race_ethnicity", "demo_comb_income_v2_comb", "demo_prnt_ed_v2_comb"),
  raw     = c("raw_slope", "raw_intercept", "race_ethnicity", "demo_comb_income_v2_comb", "demo_prnt_ed_v2_comb"),
  z_score = c("z_score_slope", "z_score_intercept", "race_ethnicity", "demo_comb_income_v2_comb", "demo_prnt_ed_v2_comb")
)

# split big df into region specific dfs
region_dfs <- split(brain_data_male, brain_data_male$current_col_name)

# Fits model per region, saves predicted values and residuals
fit_models_for_region_w_covs <- function(df_sub) {
  # for each cbcl independent variable 
  for (outcome in cbcl_outcomes) {
    for (pred_type in names(predictor_sets)) { # for each set of predictor types
      
      predictors <- predictor_sets[[pred_type]] # saves as predictors string
      formula <- as.formula(paste(outcome, "~", paste(predictors, collapse = " + "))) # builds formula
      
      model <- tryCatch(
        glm(formula, data = df_sub, family = "poisson"), # fits model
        error = function(e) return(NULL) # returns null if doesn't work (they all should)
      )
      
      if (!is.null(model)) { 
        preds <- predict(model, type = "response") # save predicted values
        actual <- model$y # grab actual values
        
        pred_col <- paste0("pred_", outcome, "_", pred_type) # make predicted values col
        resid_col <- paste0("resid_", outcome, "_", pred_type) # make residual values col
        
        # adds predicteds and residuals to df_sub matching model rows
        df_model_rows <- model.frame(model)
        idx <- match(rownames(df_model_rows), rownames(df_sub))
        
        # saves predicteds and residuals into df_sub
        df_sub[[pred_col]][idx] <- preds
        df_sub[[resid_col]][idx] <- preds - actual
      }
    }
  }
  return(df_sub)
}

region_dfs_predicted_w_covs <- lapply(region_dfs, fit_models_for_region_w_covs) # run function over all regions
brain_data_male_predicted_w_covs <- bind_rows(region_dfs_predicted_w_covs) # combine region df list back into one

region_dfs <- split(brain_data_female, brain_data_female$current_col_name)
region_dfs_predicted_w_covs <- lapply(region_dfs, fit_models_for_region_w_covs) # run function over all regions
brain_data_female_predicted_w_covs <- bind_rows(region_dfs_predicted_w_covs) # combine region df list back into one
```

```{r}
# Internalizing Scores
plot_brain_residual_diff(
  brain_data = brain_data_male_predicted_w_covs,
  residual_col = "resid_cbcl_scr_syn_internal_r_centile",
  title = "Male CBCL Internalizing Residuals Relative to White (Cortical Thickness)",
  subtitle = "Centile Predictors - Race, Income, and Education as Covariates",
  limits = c(9,11)
)
plot_brain_residual_diff(
  brain_data = brain_data_male_predicted_w_covs,
  residual_col = "resid_cbcl_scr_syn_internal_r_raw",
  title = "Male CBCL Internalizing Residuals Relative to White (Cortical Thickness)",
  subtitle = "Raw Predictors - Race, Income, and Education as Covariates",
  limits = c(9,11)
)
plot_brain_residual_diff(
  brain_data = brain_data_male_predicted_w_covs,
  residual_col = "resid_cbcl_scr_syn_internal_r_z_score",
  title = "Male CBCL Internalizing Residuals Relative to White (Cortical Thickness)",
  subtitle = "Z-Score Predictors - Race, Income, and Education as Covariates",
  limits = c(9,11)
)
```

```{r}
# Externalizing Scores
plot_brain_residual_diff(
  brain_data = brain_data_male_predicted_w_covs,
  residual_col = "resid_cbcl_scr_syn_external_r_centile",
  title = "Male CBCL Externalizing Residuals Relative to White (Cortical Thickness)",
  subtitle = "Centile Predictors - Race, Income, and Education as Covariates",
  limits = c(8, 12)
)
plot_brain_residual_diff(
  brain_data = brain_data_male_predicted_w_covs,
  residual_col = "resid_cbcl_scr_syn_external_r_raw",
  title = "Male CBCL Externalizing Residuals Relative to White (Cortical Thickness)",
  subtitle = "Raw Predictors - Race, Income, and Education as Covariates",
  limits = c(8, 12)
)
plot_brain_residual_diff(
  brain_data = brain_data_male_predicted_w_covs,
  residual_col = "resid_cbcl_scr_syn_external_r_z_score",
  title = "Male CBCL Externalizing Residuals Relative to White (Cortical Thickness)",
  subtitle = "Z-Score Predictors - Race, Income, and Education as Covariates"
)
```

```{r}
# Depression Scores
plot_brain_residual_diff(
  brain_data = brain_data_male_predicted_w_covs,
  residual_col = "resid_cbcl_scr_dsm5_depress_r_centile",
  title = "Male CBCL Depression Residuals Relative to White (Cortical Thickness)",
  subtitle = "Centile Predictors - Race, Income, and Education as Covariates",
  limits = c(-8,10)
)
plot_brain_residual_diff(
  brain_data = brain_data_male_predicted_w_covs,
  residual_col = "resid_cbcl_scr_dsm5_depress_r_raw",
  title = "Male CBCL Depression Residuals Relative to White (Cortical Thickness)",
  subtitle = "Raw Predictors - Race, Income, and Education as Covariates",
  limits = c(-8,10)
)
plot_brain_residual_diff(
  brain_data = brain_data_male_predicted_w_covs,
  residual_col = "resid_cbcl_scr_dsm5_depress_r_z_score",
  title = "Male CBCL Depression Residuals Relative to White (Cortical Thickness)",
  subtitle = "Z-Score Predictors - Race, Income, and Education as Covariates",
  limits = c(-8,10)
)
```

Let's compare different predictors
```{r}
plot_brain_residual_diff(
  brain_data = brain_data_male_predicted,
  residual_col = "resid_cbcl_scr_syn_external_r_centile",
  title = "Male CBCL Depression Residuals Relative to White (Cortical Thickness)",
  subtitle = "Centile Predictors - No Covariates",
  limits = c(0, 4)
)
plot_brain_residual_diff(
  brain_data = brain_data_male_predicted_w_race,
  residual_col = "resid_cbcl_scr_syn_external_r_centile",
  title = "Male CBCL Depression Residuals Relative to White (Cortical Thickness)",
  subtitle = "Centile Predictors - Race as Covariate",
   limits = c(0, 4)
)
plot_brain_residual_diff(
  brain_data = brain_data_male_predicted_w_covs,
  residual_col = "resid_cbcl_scr_syn_external_r_centile",
  title = "Male CBCL Depression Residuals Relative to White (Cortical Thickness)",
  subtitle = "Centile Predictors - Race, Income, and Education as Covariates",
  limits = c(0, 4)
)
```

```{r}
mean_thickness_predicted <- brain_data_male_predicted %>% 
  filter(current_col_name == "smri_thick_cdk_mean.combat") %>% 
  drop_na(cbcl_scr_dsm5_depress_r, demo_comb_income_v2_comb, demo_prnt_ed_v2_comb)

no_cov_model <- glm(formula = cbcl_scr_dsm5_depress_r ~ centile_slope + centile_intercept,
             data = mean_thickness_predicted,
             family = "poisson")
mean_thickness_predicted$no_cov_resid <- resid(no_cov_model, type = "pearson")

race_model <- glm(formula = cbcl_scr_dsm5_depress_r ~ centile_slope + centile_intercept + race_ethnicity,
             data = mean_thickness_predicted,
             family = "poisson")
mean_thickness_predicted$race_resid <- resid(race_model, type = "pearson")

race_cov_model <- glm(formula = cbcl_scr_dsm5_depress_r ~ centile_slope + centile_intercept + race_ethnicity + demo_comb_income_v2_comb + demo_prnt_ed_v2_comb,
             data = mean_thickness_predicted,
             family = "poisson")
mean_thickness_predicted$race_cov_resid <- resid(race_cov_model, type = "pearson")

mean_thickness_predicted %>%
  filter(race_ethnicity != "Missing") %>% 
  pivot_longer(cols = ends_with("resid"), names_to = "model_type", values_to = "value") %>% 
  mutate(model_type = recode(model_type,
                             no_cov_resid = "No Covariates Model",
                             race_resid = "Race as Covariate",
                             race_cov_resid = "Race, Income, and Education as Covariates")) %>% 
  ggplot(aes(x = race_ethnicity, y = value, fill = model_type)) +
  geom_boxplot(position = position_dodge(width = 0.75)) +
  labs(title = "Residuals by Race and Model Covariates",
       subtitle = "Looking at Mean Corticol Thickness for Males",
       x = "Race", y = "Residual Value",
       fill = "Model Covariates") +
  theme_minimal() 

```

```{r}
mean_thickness_predicted <- brain_data_female_predicted %>% 
  filter(current_col_name == "smri_thick_cdk_mean.combat") %>% 
  drop_na(cbcl_scr_dsm5_depress_r, demo_comb_income_v2_comb, demo_prnt_ed_v2_comb)

no_cov_model <- glm(formula = cbcl_scr_dsm5_depress_r ~ centile_slope + centile_intercept,
             data = mean_thickness_predicted,
             family = "poisson")
mean_thickness_predicted$no_cov_resid <- resid(no_cov_model, type = "pearson")

race_model <- glm(formula = cbcl_scr_dsm5_depress_r ~ centile_slope + centile_intercept + race_ethnicity,
             data = mean_thickness_predicted,
             family = "poisson")
mean_thickness_predicted$race_resid <- resid(race_model, type = "pearson")

race_cov_model <- glm(formula = cbcl_scr_dsm5_depress_r ~ centile_slope + centile_intercept + race_ethnicity + demo_comb_income_v2_comb + demo_prnt_ed_v2_comb,
             data = mean_thickness_predicted,
             family = "poisson")
mean_thickness_predicted$race_cov_resid <- resid(race_cov_model, type = "pearson")

mean_thickness_predicted %>%
  filter(race_ethnicity != "Missing") %>% 
  pivot_longer(cols = ends_with("resid"), names_to = "model_type", values_to = "value") %>% 
  mutate(model_type = recode(model_type,
                             no_cov_resid = "No Covariates Model",
                             race_resid = "Race as Covariate",
                             race_cov_resid = "Race, Income, and Education as Covariates")) %>% 
  ggplot(aes(x = race_ethnicity, y = value, fill = model_type)) +
  geom_boxplot(position = position_dodge(width = 0.75)) +
  labs(title = "Residuals by Race and Model Covariates",
       subtitle = "Looking at Mean Corticol Thickness for Females",
       x = "Race", y = "Residual Value",
       fill = "Model Covariates") +
  theme_minimal() 
```

```{r}
plot_brain_residual_diff(
  brain_data = brain_data_male_predicted,
  residual_col = "resid_cbcl_scr_syn_external_r_raw",
  title = "Male CBCL Externalizing Residuals Relative to White (Cortical Thickness)",
  subtitle = "Raw Predictors - No Covariates",
  limits=c(-13, 13)
)

plot_brain_residual_diff(
  brain_data = brain_data_male_predicted_w_covs,
  residual_col = "resid_cbcl_scr_syn_external_r_raw",
  title = "Male CBCL Externalizing Residuals Relative to White (Cortical Thickness)",
  subtitle = "Raw Predictors - Race, Income, and Education as Covariates",
  limits=c(-13, 13)
)
```

